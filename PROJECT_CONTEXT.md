# UI Inventory App — Project Context (Updated Canon)

_Last updated: 2025-12-17 (Europe/Madrid)_

## What we are building
A system for **guided UI capture** and **viewer-side analysis**:

1) **Chrome Extension (MV3)**
- User selects elements on real web pages.
- Extension captures structured evidence:
  - element locator / intent anchors
  - normalized style primitives (and minimal supporting metadata)
  - screenshot evidence (stored as blob, referenced by ID)
- Extension stores captures in IndexedDB **via the service worker**.

2) **Viewer (web app)**
- Built with **Vite** into `dist/viewer.html`.
- Opened from extension popup via:
  - `chrome.runtime.getURL("viewer.html")`
- Viewer reads data **only via message passing** to the service worker.
- Viewer provides gallery, grouping, compare, and export.

> We are **not** claiming complete UI coverage.
> We are claiming: **guided capture + automatic grouping of what you captured**.

---

## Hard rules (architecture)
### Service worker is the only IndexedDB accessor
- Popup + Viewer **must not** read/write IndexedDB directly.
- All persistence + retrieval happens through service worker message handlers.

### Message passing only
- UI contexts call `chrome.runtime.sendMessage(...)` and receive structured responses.
- **Binary constraint:** ArrayBuffers cannot be transferred reliably through MV3 message passing.
  - Screenshots are returned as `{ ok: true, arrayBuffer: number[] }` and reconstructed to ArrayBuffer/Blob in the viewer.

---

## Repo outputs
- **Chrome extension (MV3)**: capture + storage + popup entrypoints.
- **Viewer web app**: `viewer.html` generated by Vite build and packaged with extension.

---

## Data model (high level)
### Session
A session represents a capture run (a logical grouping of captures).
- Each capture has a `sessionId`.
- Sessions store basic metadata (createdAt, url/site hints, etc.).

### Capture
Each capture is a record of a single selected element + evidence.
Key concepts:
- **Intent anchors:** e.g. normalized accessible name, role-ish hints, tagName, etc.
- **Conditions:** evidence context needed to compare later (viewport, DPR, theme hint, etc.).
- **Styles:** normalized **primitives** (not only raw computed strings).
- **Screenshot reference:** capture references a blob id; bytes stored separately.

Versioning is present:
- `captureSchemaVersion: 2`
- `stylePrimitiveVersion: 1`

---

## IndexedDB (conceptual)
(Exact store names may vary, but conceptually:)
- `sessions` store
- `captures` store
- `blobs` store (screenshot bytes)
- (optional) indexes by `sessionId` etc.

---

## Message protocol (canon shapes)

### Viewer → Service worker
**VIEWER/LIST_SESSIONS**
- Request: `{ type: "VIEWER/LIST_SESSIONS" }`
- Response: `{ ok: true, sessions: SessionSummary[] }` or `{ ok: false, error: string }`

**VIEWER/LIST_CAPTURES**
- Request: `{ type: "VIEWER/LIST_CAPTURES", sessionId: string }`
- Response: `{ ok: true, captures: CaptureListItem[] }` or `{ ok: false, error: string }`

**VIEWER/GET_CAPTURE**
- Request: `{ type: "VIEWER/GET_CAPTURE", captureId: string }`
- Response: `{ ok: true, capture: CaptureFull }` or `{ ok: false, error: string }`

### Viewer → Service worker (blob access)
**AUDIT/GET_BLOB**
- Request: `{ type: "AUDIT/GET_BLOB", blobId: string }`
- Response success:
  - `{ ok: true, arrayBuffer: number[] }`
- Response failure:
  - `{ ok: false, error?: string }`

> Viewer reconstructs blob bytes from `number[]` → `Uint8Array` → `Blob` → `URL.createObjectURL`.

---

## Viewer (Milestone 2 v2.2 — COMPLETE)

### Core UI
- Sessions list (left sidebar)
- Capture gallery (main pane)
- Thumbnails (via blob fetch)
- Filters (combine correctly):
  - substring search on accessible name
  - has screenshot toggle
  - tag/type filter dropdown

### Grouping (naive clustering)
Viewer-side grouping only (no stored signatures/dedupe keys in capture).
- Group key:
  - `tagName` + `normalizeAccessibleName(accessibleName)`
- Group view shows:
  - group label
  - count of occurrences
  - representative thumbnails
- Group detail shows occurrences using same capture cards.

### Compare A/B
- Select two captures (A/B) from the gallery.
- Compare panel shows:
  - screenshots side-by-side
  - primitives diff: only differing paths are displayed

### Export
- JSON export:
  - exports session + captures
  - **does not embed image bytes**
  - uses screenshot blob id references
  - strips `styles.computed` from JSON payload
- CSV export:
  - flattened rows with stable schema mapping
- Export UX:
  - status: exporting / success / error
  - **progress**: “Exporting X / Y…”
  - batching + yielding to keep UI responsive

### Resilience + polish
- Loading + error states for sessions/captures with Retry
- Empty states:
  - “No captures in this session yet.”
  - “No captures match your filters.” + Clear filters
- Screenshot UI:
  - “No screenshot” if no blob id
  - “Missing blob” if blob fetch fails/empty bytes (deduped logging)
- Stale request protection for capture loads (ignore out-of-order responses)
- Blob URL caching + cleanup on unmount
- GroupCard async cancellation guard (avoid setState after unmount)
- Capture cards include a visible **type/tag chip**
- Group label tooltip for truncated text
- Minimal keyboard `:focus-visible` styling

---

## Element locator strategy (current intent)
We store enough evidence to find/understand the element later, but we are not claiming perfect re-identification.
Typical anchors include:
- tagName
- accessible name (normalized)
- intent-ish fields (role-like hints, labels, etc.)
- (and whatever locator strategy you’ve standardized in capture payload)

---

## Performance expectations (current)
- Viewer is optimized for “normal” sessions (~100–300 captures).
- No virtualization yet; defer to Milestone 3 if needed for huge sets (1000+).
- Export is chunked/yielded to reduce UI freeze.

---

## Current milestone status
### Milestone 1 v2.2 — COMPLETE
- Capture + evidence + storage through MV3 service worker
- Versioning present
- Conditions + primitives captured per canon

### Milestone 2 v2.2 — COMPLETE
- Viewer gallery + naive grouping + compare + export + polish

---

## Milestone 3 (next planning target)
Milestone 3 should build on the viewer to improve **analysis/clustering** and scaling without moving complexity back into the extension.
Likely themes (subject to planning):
- Better similarity heuristics beyond `tagName + accessibleName`
  - incorporate primitives buckets (spacing, colors, typography, shadow presence)
- Optional “viewer-side signatures” (computed in viewer, not stored by extension)
- Large-session performance (virtualization / pagination) if needed
- Workflow polish around groups/compare for variant detection

---

## Key constraints to preserve
- Service worker is the only IndexedDB accessor
- Viewer uses message passing only
- Screenshot bytes are transferred as `number[]` (not ArrayBuffer)
- Keep claims modest: guided capture + automatic grouping of what was captured
