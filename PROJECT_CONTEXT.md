# UI Inventory App — Project Context (Updated Canon)

_Last updated: 2025-12-17 (Europe/Madrid)_

## What we are building
A system for **guided UI capture** and **viewer-side analysis**:

1) **Chrome Extension (MV3)**
- User selects elements on real web pages.
- Extension captures structured evidence:
  - element locator / intent anchors
  - normalized style primitives (and minimal supporting metadata)
  - screenshot evidence (stored as blob, referenced by ID)
- Extension stores captures in IndexedDB **via the service worker**.

2) **Viewer (web app)**
- Built with **Vite** into `dist/viewer.html`.
- Opened from extension popup via:
  - `chrome.runtime.getURL("viewer.html")`
- Viewer reads data **only via message passing** to the service worker.
- Viewer provides gallery, grouping, compare, and export.

> We are **not** claiming complete UI coverage.
> We are claiming: **guided capture + automatic grouping of what you captured**.

---

## Hard rules (architecture)
### Service worker is the only IndexedDB accessor
- Popup + Viewer **must not** read/write IndexedDB directly.
- All persistence + retrieval happens through service worker message handlers.

### Message passing only
- UI contexts call `chrome.runtime.sendMessage(...)` and receive structured responses.
- **Binary constraint:** ArrayBuffers cannot be transferred reliably through MV3 message passing.
  - Screenshots are returned as `{ ok: true, arrayBuffer: number[] }` and reconstructed to ArrayBuffer/Blob in the viewer.

---

## Repo outputs
- **Chrome extension (MV3)**: capture + storage + popup entrypoints.
- **Viewer web app**: `viewer.html` generated by Vite build and packaged with extension.

---

## Data model (high level)
### Session
A session represents a capture run (a logical grouping of captures).
- Each capture has a `sessionId`.
- Sessions store basic metadata (createdAt, url/site hints, etc.).

### Capture
Each capture is a record of a single selected element + evidence.
Key concepts:
- **Intent anchors:** e.g. normalized accessible name, role-ish hints, tagName, etc.
- **Conditions:** evidence context needed to compare later (viewport, DPR, theme hint, etc.).
- **Styles:** normalized **primitives** (not only raw computed strings).
- **Screenshot reference:** capture references a blob id; bytes stored separately.

Versioning is present:
- `captureSchemaVersion: 2`
- `stylePrimitiveVersion: 1`

---

## IndexedDB (conceptual)
(Exact store names may vary, but conceptually:)
- `sessions` store
- `captures` store
- `blobs` store (screenshot bytes)
- (optional) indexes by `sessionId` etc.

---

## Message protocol (canon shapes)

### Viewer → Service worker
**VIEWER/LIST_SESSIONS**
- Request: `{ type: "VIEWER/LIST_SESSIONS" }`
- Response: `{ ok: true, sessions: SessionSummary[] }` or `{ ok: false, error: string }`

**VIEWER/LIST_CAPTURES**
- Request: `{ type: "VIEWER/LIST_CAPTURES", sessionId: string }`
- Response: `{ ok: true, captures: CaptureListItem[] }` or `{ ok: false, error: string }`

**VIEWER/GET_CAPTURE**
- Request: `{ type: "VIEWER/GET_CAPTURE", captureId: string }`
- Response: `{ ok: true, capture: CaptureFull }` or `{ ok: false, error: string }`

### Viewer → Service worker (blob access)
**AUDIT/GET_BLOB**
- Request: `{ type: "AUDIT/GET_BLOB", blobId: string }`
- Response success:
  - `{ ok: true, arrayBuffer: number[] }`
- Response failure:
  - `{ ok: false, error?: string }`

> Viewer reconstructs blob bytes from `number[]` → `Uint8Array` → `Blob` → `URL.createObjectURL`.

---

## Viewer (Milestone 2 v2.2 + Milestone 3 — COMPLETE)

### Core UI
- Sessions list (left sidebar)
- Capture gallery (main pane)
- Thumbnails (via blob fetch)
- Filters (combine correctly):
  - substring search on accessible name + selector
  - has screenshot toggle
  - tag/type filter dropdown

### Grouping (Milestone 3 — explainable clustering)
Viewer-side grouping only (no stored signatures/dedupe keys in capture).

**Grouping modes** (dropdown selection):
- **Tag + Name:** `tagName::normalizedName` (default, fast)
- **Tag + Role + Name:** `tagName::role::normalizedName`
- **Tag + Role + Name + Primitives:** includes bucketed padding/colors/shadow

**Primitives bucketing:**
- Padding: rounded to nearest 4px
- Colors (RGB): 16-step buckets (0,16,32...240), alpha to 0.1 precision
- Shadow: presence + layer count

**Group cards show:**
- Group label with tooltip (for truncated text)
- Count of occurrences
- Representative thumbnails
- **"Why?" tooltip** showing grouping criteria:
  - Base fields: tag, role (when not "norole"), name
  - Primitives breakdown (when primitives mode): padding, colors, shadow tokens

**Group detail view:**
- Shows all captures in the group
- **Variant detection:**
  - Computes variants using primitives bucketing
  - Shows "Variants: N" count
  - Variant filter chips (only when N > 1): "Variant 1 (5)", "Variant 2 (3)", etc.
  - Click chip to filter by variant; "All variants" chip to clear
  - Each capture card shows "V{index}" badge when multiple variants exist
  - Variants sorted deterministically (count DESC, then key ASC)
  - Memoized computation (no rebuild on every render)

### Compare A/B
- Select two captures (A/B) from the gallery.
- Compare panel shows:
  - screenshots side-by-side
  - primitives diff: only differing paths are displayed

### Export
- **JSON export:**
  - exports session + captures
  - **does not embed image bytes**
  - uses screenshot blob id references
  - strips `styles.computed` from JSON payload
- **CSV export:**
  - flattened rows with stable schema mapping
- **Export UX:**
  - status: exporting / success / error
  - **progress**: "Exporting X / Y…"
  - batching + yielding to keep UI responsive
- **Optional viewer-derived fields (Milestone 3):**
  - Checkbox: "Include viewer-derived grouping fields"
  - When enabled, JSON adds `viewerDerived` object to each capture:
    - `groupingMode`, `groupKey`, `variantKey`, `signatureVersion: 1`
  - When enabled, CSV appends 4 columns:
    - `viewer_grouping_mode`, `viewer_group_key`, `viewer_variant_key`, `viewer_signature_version`
  - Fields matched by capture ID (handles partial export failures)
  - **Export-only:** not persisted to IndexedDB

### Resilience + polish
- Loading + error states for sessions/captures with Retry
- Empty states:
  - “No captures in this session yet.”
  - “No captures match your filters.” + Clear filters
- Screenshot UI:
  - “No screenshot” if no blob id
  - “Missing blob” if blob fetch fails/empty bytes (deduped logging)
- Stale request protection for capture loads (ignore out-of-order responses)
- Blob URL caching + cleanup on unmount
- GroupCard async cancellation guard (avoid setState after unmount)
- Capture cards include a visible **type/tag chip**
- Group label tooltip for truncated text
- Minimal keyboard `:focus-visible` styling

---

## Element locator strategy (current intent)
We store enough evidence to find/understand the element later, but we are not claiming perfect re-identification.
Typical anchors include:
- tagName
- accessible name (normalized)
- intent-ish fields (role-like hints, labels, etc.)
- (and whatever locator strategy you’ve standardized in capture payload)

---

## Performance expectations (current)
- Viewer is optimized for “normal” sessions (~100–300 captures).
- No virtualization yet; defer to Milestone 3 if needed for huge sets (1000+).
- Export is chunked/yielded to reduce UI freeze.

---

## Current milestone status
### Milestone 1 v2.2 — COMPLETE
- Capture + evidence + storage through MV3 service worker
- Versioning present
- Conditions + primitives captured per canon

### Milestone 2 v2.2 — COMPLETE
- Viewer gallery + naive grouping + compare + export + polish

### Milestone 3 — COMPLETE (2025-12-17)
- **Explainable clustering:**
  - Three grouping modes: Tag+Name, Tag+Role+Name, Tag+Role+Name+Primitives
  - Primitives bucketing (padding, colors, shadow)
  - "Why grouped?" tooltips showing grouping criteria
- **Variant detection:**
  - Within-group variant clusters using primitives
  - Variant filter chips + V{index} badges
  - Deterministic ordering (count DESC, key ASC)
  - Memoized computation
- **Export enhancement:**
  - Optional viewer-derived fields (groupKey, variantKey, etc.)
  - JSON `viewerDerived` object, CSV appended columns
  - Export-only (not persisted)

---

## Key constraints to preserve
- Service worker is the only IndexedDB accessor
- Viewer uses message passing only
- Screenshot bytes are transferred as `number[]` (not ArrayBuffer)
- Keep claims modest: guided capture + automatic grouping of what was captured
